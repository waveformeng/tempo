<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tempo | Time Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0b;
      --bg-secondary: #141416;
      --bg-tertiary: #1c1c1f;
      --bg-card: #18181b;
      --border: #27272a;
      --border-hover: #3f3f46;
      --text-primary: #fafafa;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --accent: #f97316;
      --accent-hover: #fb923c;
      --accent-subtle: rgba(249, 115, 22, 0.1);
      --success: #22c55e;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Layout */
    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      padding: 32px 20px;
      display: flex;
      flex-direction: column;
    }

    .logo {
      font-family: 'Fraunces', serif;
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .logo span {
      color: var(--accent);
    }

    .tagline {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 40px;
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .nav-item:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--accent-subtle);
      color: var(--accent);
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
      opacity: 0.8;
    }

    .nav-item.active svg {
      opacity: 1;
    }

    /* Main Content */
    .main {
      padding: 32px 48px;
      overflow-y: auto;
      background: 
        radial-gradient(ellipse at 0% 0%, rgba(249, 115, 22, 0.03) 0%, transparent 50%),
        var(--bg-primary);
    }

    .view {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .view.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .page-title {
      font-family: 'Fraunces', serif;
      font-size: 32px;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      transition: all 0.2s ease;
    }

    .stat-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-2px);
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-family: 'Fraunces', serif;
      font-size: 36px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .stat-value.accent {
      color: var(--accent);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .btn-danger {
      background: transparent;
      color: var(--danger);
      padding: 8px;
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    .btn-icon {
      padding: 8px;
      background: transparent;
      color: var(--text-secondary);
    }

    .btn-icon:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .btn svg {
      width: 18px;
      height: 18px;
    }

    /* Tables */
    .table-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 16px 20px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.02);
    }

    .actions {
      display: flex;
      gap: 4px;
      justify-content: flex-end;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      background: var(--accent-subtle);
      color: var(--accent);
    }

    /* Forms */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group.full {
      grid-column: 1 / -1;
    }

    label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    input, select, textarea {
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-subtle);
    }

    input::placeholder, textarea::placeholder {
      color: var(--text-muted);
    }

    select {
      cursor: pointer;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 32px;
      width: 100%;
      max-width: 500px;
      box-shadow: var(--shadow);
      transform: scale(0.95);
      transition: transform 0.2s ease;
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-title {
      font-family: 'Fraunces', serif;
      font-size: 24px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      transition: color 0.2s ease;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 28px;
    }

    /* Client Breakdown */
    .breakdown-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 32px;
    }

    .breakdown-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .breakdown-info h4 {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .breakdown-info span {
      font-size: 13px;
      color: var(--text-muted);
    }

    .breakdown-stats {
      display: flex;
      gap: 32px;
      text-align: right;
    }

    .breakdown-stat-value {
      font-family: 'Fraunces', serif;
      font-size: 20px;
      font-weight: 600;
    }

    .breakdown-stat-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Filter Bar */
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 24px;
      padding: 16px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    .filter-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .filter-label {
      font-size: 13px;
      color: var(--text-muted);
      margin-right: 4px;
    }

    .filter-btn {
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-family: inherit;
    }

    .filter-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .filter-btn.active {
      background: var(--accent-subtle);
      color: var(--accent);
      border-color: var(--accent);
    }

    .filter-divider {
      width: 1px;
      height: 24px;
      background: var(--border);
      margin: 0 8px;
    }

    .date-input {
      padding: 8px 12px;
      font-size: 13px;
      width: 140px;
    }

    /* View Toggle */
    .view-toggle {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
    }

    .view-toggle-btn {
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-family: inherit;
    }

    .view-toggle-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .view-toggle-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    /* Expandable Client Card */
    .breakdown-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .breakdown-header {
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .breakdown-header:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .breakdown-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .breakdown-toggle svg {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
      transition: transform 0.2s ease;
    }

    .breakdown-card.expanded .breakdown-toggle svg {
      transform: rotate(90deg);
    }

    .breakdown-jobs {
      display: none;
      border-top: 1px solid var(--border);
      background: var(--bg-secondary);
    }

    .breakdown-card.expanded .breakdown-jobs {
      display: block;
    }

    .job-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px 12px 48px;
      border-bottom: 1px solid var(--border);
    }

    .job-row:last-child {
      border-bottom: none;
    }

    .job-name {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .job-stats {
      display: flex;
      gap: 24px;
      text-align: right;
    }

    .job-stat-value {
      font-size: 14px;
      font-weight: 500;
    }

    .job-stat-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Flat Table */
    .flat-table-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .flat-table th {
      cursor: pointer;
      user-select: none;
    }

    .flat-table th:hover {
      background: var(--bg-tertiary);
    }

    .flat-table .sort-icon {
      margin-left: 4px;
      opacity: 0.5;
    }

    .flat-table th.sorted .sort-icon {
      opacity: 1;
      color: var(--accent);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state p {
      margin-bottom: 20px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .app {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        display: none;
      }
      
      .main {
        padding: 24px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">Temp<span>o</span></div>
      <p class="tagline">Track time, not stress</p>
      
      <nav class="nav">
        <button class="nav-item active" data-view="dashboard">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="9"></rect>
            <rect x="14" y="3" width="7" height="5"></rect>
            <rect x="14" y="12" width="7" height="9"></rect>
            <rect x="3" y="16" width="7" height="5"></rect>
          </svg>
          Dashboard
        </button>
        <button class="nav-item" data-view="time">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          Time Entries
        </button>
        <button class="nav-item" data-view="clients">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
          Clients
        </button>
        <button class="nav-item" data-view="jobs">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
          </svg>
          Jobs
        </button>
        <button class="nav-item" data-view="invoices">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          Invoices
        </button>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <!-- Dashboard View -->
      <div id="dashboard" class="view active">
        <header class="page-header">
          <h1 class="page-title">Dashboard</h1>
          <button class="btn btn-primary" onclick="showModal('time')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Log Time
          </button>
        </header>

        <!-- Date Filter Bar -->
        <div class="filter-bar">
          <span class="filter-label">Period:</span>
          <div class="filter-group">
            <button class="filter-btn active" data-preset="all" onclick="setDatePreset('all')">All Time</button>
            <button class="filter-btn" data-preset="week" onclick="setDatePreset('week')">This Week</button>
            <button class="filter-btn" data-preset="month" onclick="setDatePreset('month')">This Month</button>
            <button class="filter-btn" data-preset="lastMonth" onclick="setDatePreset('lastMonth')">Last Month</button>
          </div>
          <div class="filter-divider"></div>
          <div class="filter-group">
            <input type="date" id="filter-start" class="date-input" onchange="applyCustomDateFilter()">
            <span class="filter-label">to</span>
            <input type="date" id="filter-end" class="date-input" onchange="applyCustomDateFilter()">
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Hours</div>
            <div class="stat-value" id="stat-hours">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Earnings</div>
            <div class="stat-value accent" id="stat-earnings">$0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Active Clients</div>
            <div class="stat-value" id="stat-clients">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Time Entries</div>
            <div class="stat-value" id="stat-entries">0</div>
          </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="font-family: 'Fraunces', serif; font-size: 20px;">Breakdown</h2>
          <div class="view-toggle">
            <button class="view-toggle-btn active" data-view-mode="hierarchical" onclick="setReportView('hierarchical')">By Client</button>
            <button class="view-toggle-btn" data-view-mode="flat" onclick="setReportView('flat')">Flat</button>
          </div>
        </div>
        <div class="breakdown-list" id="client-breakdown"></div>
        <div class="flat-table-container" id="flat-breakdown" style="display: none;"></div>
      </div>

      <!-- Time Entries View -->
      <div id="time" class="view">
        <header class="page-header">
          <h1 class="page-title">Time Entries</h1>
          <button class="btn btn-primary" onclick="showModal('time')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Log Time
          </button>
        </header>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Client</th>
                <th>Job</th>
                <th>Hours</th>
                <th>Amount</th>
                <th>Description</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="time-entries-table"></tbody>
          </table>
        </div>
      </div>

      <!-- Clients View -->
      <div id="clients" class="view">
        <header class="page-header">
          <h1 class="page-title">Clients</h1>
          <button class="btn btn-primary" onclick="showModal('client')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Client
          </button>
        </header>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Client Name</th>
                <th>Hourly Rate</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="clients-table"></tbody>
          </table>
        </div>
      </div>

      <!-- Jobs View -->
      <div id="jobs" class="view">
        <header class="page-header">
          <h1 class="page-title">Jobs</h1>
          <button class="btn btn-primary" onclick="showModal('job')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Job
          </button>
        </header>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Job Name</th>
                <th>Job #</th>
                <th>Client</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="jobs-table"></tbody>
          </table>
        </div>
      </div>

      <!-- Invoices View -->
      <div id="invoices" class="view">
        <header class="page-header">
          <h1 class="page-title">Invoices</h1>
          <button class="btn btn-primary" onclick="showModal('invoice')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Create Invoice
          </button>
        </header>

        <div class="filter-bar">
          <span class="filter-label">Status:</span>
          <div class="filter-group">
            <button class="filter-btn active" data-invoice-status="all" onclick="filterInvoices('all')">All</button>
            <button class="filter-btn" data-invoice-status="unpaid" onclick="filterInvoices('unpaid')">Unpaid</button>
            <button class="filter-btn" data-invoice-status="paid" onclick="filterInvoices('paid')">Paid</button>
          </div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Client</th>
                <th>Job / PO</th>
                <th>Period</th>
                <th>Amount</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="invoices-table"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Client Modal -->
  <div class="modal-overlay" id="client-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="client-modal-title">Add Client</h2>
        <button class="modal-close" onclick="closeModal('client')">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <form id="client-form" onsubmit="saveClient(event)">
        <input type="hidden" id="client-id">
        <div class="form-grid">
          <div class="form-group">
            <label for="client-name">Client Name</label>
            <input type="text" id="client-name" placeholder="Acme Corp" required>
          </div>
          <div class="form-group">
            <label for="client-rate">Hourly Rate ($)</label>
            <input type="number" id="client-rate" placeholder="150" step="0.01" min="0" required>
          </div>
          <div class="form-group full">
            <label for="client-street">Street Address</label>
            <input type="text" id="client-street" placeholder="123 Main St">
          </div>
          <div class="form-group">
            <label for="client-city">City</label>
            <input type="text" id="client-city" placeholder="San Francisco">
          </div>
          <div class="form-group">
            <label for="client-state">State</label>
            <input type="text" id="client-state" placeholder="CA" maxlength="2" style="text-transform: uppercase;">
          </div>
          <div class="form-group">
            <label for="client-zip">Zip Code</label>
            <input type="text" id="client-zip" placeholder="94102">
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal('client')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Client</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Job Modal -->
  <div class="modal-overlay" id="job-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="job-modal-title">Add Job</h2>
        <button class="modal-close" onclick="closeModal('job')">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <form id="job-form" onsubmit="saveJob(event)">
        <input type="hidden" id="job-id">
        <div class="form-grid">
          <div class="form-group">
            <label for="job-client">Client</label>
            <select id="job-client" required></select>
          </div>
          <div class="form-group">
            <label for="job-number">Job # / PO #</label>
            <input type="text" id="job-number" placeholder="PO-12345">
          </div>
          <div class="form-group full">
            <label for="job-name">Job Name</label>
            <input type="text" id="job-name" placeholder="Website Redesign" required>
          </div>
          <div class="form-group">
            <label for="job-contact-name">Contact Name</label>
            <input type="text" id="job-contact-name" placeholder="John Smith">
          </div>
          <div class="form-group">
            <label for="job-contact-email">Contact Email</label>
            <input type="email" id="job-contact-email" placeholder="john@example.com">
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal('job')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Job</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Time Entry Modal -->
  <div class="modal-overlay" id="time-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="time-modal-title">Log Time</h2>
        <button class="modal-close" onclick="closeModal('time')">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <form id="time-form" onsubmit="saveTimeEntry(event)">
        <input type="hidden" id="time-id">
        <div class="form-grid">
          <div class="form-group">
            <label for="time-client">Client</label>
            <select id="time-client" required onchange="loadJobsForClient()"></select>
          </div>
          <div class="form-group">
            <label for="time-job">Job</label>
            <select id="time-job" required></select>
          </div>
          <div class="form-group">
            <label for="time-date">Date</label>
            <input type="date" id="time-date" required>
          </div>
          <div class="form-group">
            <label for="time-hours">Hours</label>
            <input type="number" id="time-hours" placeholder="2.5" step="0.25" min="0.25" required>
          </div>
          <div class="form-group full">
            <label for="time-description">Description (optional)</label>
            <textarea id="time-description" placeholder="What did you work on?"></textarea>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal('time')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Entry</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div class="modal-overlay" id="invoice-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="invoice-modal-title">Create Invoice</h2>
        <button class="modal-close" onclick="closeModal('invoice')">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <form id="invoice-form" onsubmit="createInvoice(event)">
        <div class="form-grid">
          <div class="form-group">
            <label for="invoice-client">Client</label>
            <select id="invoice-client" required onchange="loadJobsForInvoice()"></select>
          </div>
          <div class="form-group">
            <label for="invoice-job">Job / PO</label>
            <select id="invoice-job" required></select>
          </div>
          <div class="form-group">
            <label for="invoice-start">Start Date</label>
            <input type="date" id="invoice-start" required>
          </div>
          <div class="form-group">
            <label for="invoice-end">End Date</label>
            <input type="date" id="invoice-end" required>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal('invoice')">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Invoice</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Quick Invoice Modal (from Job row) -->
  <div class="modal-overlay" id="quick-invoice-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Create Invoice</h2>
        <button class="modal-close" onclick="closeQuickInvoiceModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <form id="quick-invoice-form" onsubmit="submitQuickInvoice(event)">
        <input type="hidden" id="quick-invoice-client-id">
        <input type="hidden" id="quick-invoice-job-id">
        <div class="form-group" style="margin-bottom: 16px;">
          <label style="font-size: 14px; color: var(--text-primary);">Job: <strong id="quick-invoice-job-name"></strong></label>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="quick-invoice-start">Start Date</label>
            <input type="date" id="quick-invoice-start" required>
          </div>
          <div class="form-group">
            <label for="quick-invoice-end">End Date</label>
            <input type="date" id="quick-invoice-end" required>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeQuickInvoiceModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Invoice</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API = '';

    // State
    let clients = [];
    let jobs = [];
    let timeEntries = [];
    let invoices = [];
    let stats = {};
    let invoiceStatusFilter = 'all';

    // Report state
    let reportFilters = {
      startDate: null,
      endDate: null,
      preset: 'all'
    };
    let reportView = 'hierarchical';
    let flatSortColumn = 'earnings';
    let flatSortDirection = 'desc';

    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        item.classList.add('active');
        document.getElementById(item.dataset.view).classList.add('active');
      });
    });

    // API Functions
    async function fetchData() {
      try {
        // Build stats URL with date params if set
        let statsUrl = `${API}/api/stats`;
        const params = new URLSearchParams();
        if (reportFilters.startDate) params.append('startDate', reportFilters.startDate);
        if (reportFilters.endDate) params.append('endDate', reportFilters.endDate);
        if (params.toString()) statsUrl += `?${params.toString()}`;

        const [clientsRes, jobsRes, entriesRes, statsRes, invoicesRes] = await Promise.all([
          fetch(`${API}/api/clients`),
          fetch(`${API}/api/jobs`),
          fetch(`${API}/api/time-entries`),
          fetch(statsUrl),
          fetch(`${API}/api/invoices`)
        ]);

        clients = await clientsRes.json();
        jobs = await jobsRes.json();
        timeEntries = await entriesRes.json();
        stats = await statsRes.json();
        invoices = await invoicesRes.json();

        renderAll();
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }

    function renderAll() {
      renderStats();
      renderClients();
      renderJobs();
      renderTimeEntries();
      renderClientBreakdown();
      renderInvoices();
    }

    function renderStats() {
      document.getElementById('stat-hours').textContent = stats.totalHours || 0;
      document.getElementById('stat-earnings').textContent = `$${(stats.totalEarnings || 0).toLocaleString()}`;
      document.getElementById('stat-clients').textContent = stats.clientCount || 0;
      document.getElementById('stat-entries').textContent = stats.entryCount || 0;
    }

    function renderClientBreakdown() {
      const container = document.getElementById('client-breakdown');
      if (!stats.byClient || stats.byClient.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>No client data yet. Start logging time!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = stats.byClient.map(client => `
        <div class="breakdown-card" data-client-id="${client.clientId}">
          <div class="breakdown-header" onclick="toggleClientExpand('${client.clientId}')">
            <div class="breakdown-toggle">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
              <div class="breakdown-info">
                <h4>${client.name}</h4>
                <span>$${client.rate}/hr · ${client.jobs ? client.jobs.length : 0} job${client.jobs && client.jobs.length !== 1 ? 's' : ''}</span>
              </div>
            </div>
            <div class="breakdown-stats">
              <div>
                <div class="breakdown-stat-value">${client.hours.toFixed(1)}</div>
                <div class="breakdown-stat-label">Hours</div>
              </div>
              <div>
                <div class="breakdown-stat-value" style="color: var(--accent)">$${client.earnings.toLocaleString()}</div>
                <div class="breakdown-stat-label">Earnings</div>
              </div>
            </div>
          </div>
          <div class="breakdown-jobs">
            ${client.jobs && client.jobs.length > 0 ? client.jobs.map(job => `
              <div class="job-row">
                <span class="job-name">${job.name}</span>
                <div class="job-stats">
                  <div>
                    <div class="job-stat-value">${job.hours.toFixed(1)}</div>
                    <div class="job-stat-label">Hours</div>
                  </div>
                  <div>
                    <div class="job-stat-value" style="color: var(--accent)">$${job.earnings.toLocaleString()}</div>
                    <div class="job-stat-label">Earnings</div>
                  </div>
                </div>
              </div>
            `).join('') : '<div class="job-row"><span class="job-name" style="color: var(--text-muted);">No jobs</span></div>'}
          </div>
        </div>
      `).join('');
    }

    function toggleClientExpand(clientId) {
      const card = document.querySelector(`.breakdown-card[data-client-id="${clientId}"]`);
      if (card) {
        card.classList.toggle('expanded');
      }
    }

    function renderFlatBreakdown() {
      const container = document.getElementById('flat-breakdown');
      if (!stats.byClient || stats.byClient.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>No data for the selected period.</p>
          </div>
        `;
        return;
      }

      // Flatten client/job data
      let flatData = [];
      stats.byClient.forEach(client => {
        if (client.jobs && client.jobs.length > 0) {
          client.jobs.forEach(job => {
            flatData.push({
              clientName: client.name,
              jobName: job.name,
              hours: job.hours,
              earnings: job.earnings
            });
          });
        } else {
          flatData.push({
            clientName: client.name,
            jobName: '(No job)',
            hours: client.hours,
            earnings: client.earnings
          });
        }
      });

      // Sort data
      flatData.sort((a, b) => {
        let aVal = a[flatSortColumn];
        let bVal = b[flatSortColumn];
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }
        if (flatSortDirection === 'asc') {
          return aVal > bVal ? 1 : -1;
        } else {
          return aVal < bVal ? 1 : -1;
        }
      });

      const getSortIcon = (column) => {
        if (flatSortColumn !== column) return '<span class="sort-icon">↕</span>';
        return `<span class="sort-icon">${flatSortDirection === 'asc' ? '↑' : '↓'}</span>`;
      };

      const getSortedClass = (column) => flatSortColumn === column ? 'sorted' : '';

      container.innerHTML = `
        <table class="flat-table">
          <thead>
            <tr>
              <th class="${getSortedClass('clientName')}" onclick="sortFlatTable('clientName')">Client ${getSortIcon('clientName')}</th>
              <th class="${getSortedClass('jobName')}" onclick="sortFlatTable('jobName')">Job ${getSortIcon('jobName')}</th>
              <th class="${getSortedClass('hours')}" onclick="sortFlatTable('hours')">Hours ${getSortIcon('hours')}</th>
              <th class="${getSortedClass('earnings')}" onclick="sortFlatTable('earnings')">Earnings ${getSortIcon('earnings')}</th>
            </tr>
          </thead>
          <tbody>
            ${flatData.map(row => `
              <tr>
                <td><strong>${row.clientName}</strong></td>
                <td>${row.jobName}</td>
                <td>${row.hours.toFixed(1)}h</td>
                <td><span class="badge">$${row.earnings.toLocaleString()}</span></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function sortFlatTable(column) {
      if (flatSortColumn === column) {
        flatSortDirection = flatSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        flatSortColumn = column;
        flatSortDirection = column === 'hours' || column === 'earnings' ? 'desc' : 'asc';
      }
      renderFlatBreakdown();
    }

    function renderClients() {
      const tbody = document.getElementById('clients-table');
      if (clients.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="3" class="empty-state">
              <p>No clients yet. Add your first client!</p>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = clients.map(client => `
        <tr>
          <td><strong>${client.name}</strong></td>
          <td><span class="badge">$${client.rate}/hr</span></td>
          <td>
            <div class="actions">
              <button class="btn btn-icon" onclick="editClient('${client._id}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
              <button class="btn btn-danger" onclick="deleteClient('${client._id}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function renderJobs() {
      const tbody = document.getElementById('jobs-table');
      if (jobs.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="empty-state">
              <p>No jobs yet. Add a client first, then create jobs!</p>
            </td>
          </tr>
        `;
        return;
      }

      const clientMap = Object.fromEntries(clients.map(c => [c._id, c]));

      tbody.innerHTML = jobs.map(job => {
        const client = clientMap[job.clientId];
        const clientName = client?.name || 'Unknown';
        return `
        <tr>
          <td><strong>${job.name}</strong></td>
          <td>${job.jobNumber || '-'}</td>
          <td>${clientName}</td>
          <td>
            <div class="actions">
              <button class="btn btn-icon" onclick="showQuickInvoiceModal('${job._id}')" title="Create Invoice">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
              </button>
              <button class="btn btn-icon" onclick="editJob('${job._id}')" title="Edit Job">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
              <button class="btn btn-danger" onclick="deleteJob('${job._id}')" title="Delete Job">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `}).join('');
    }

    function renderTimeEntries() {
      const tbody = document.getElementById('time-entries-table');
      if (timeEntries.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <p>No time entries yet. Start tracking!</p>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = timeEntries.map(entry => {
        const date = new Date(entry.date).toLocaleDateString('en-US', {
          month: 'short', day: 'numeric', year: 'numeric',
          timeZone: 'UTC'
        });
        const clientName = entry.client?.name || 'Unknown';
        const jobName = entry.job?.name || 'Unknown';
        const rate = entry.client?.rate || 0;
        const amount = entry.hours * rate;
        
        return `
          <tr>
            <td>${date}</td>
            <td><strong>${clientName}</strong></td>
            <td>${jobName}</td>
            <td>${entry.hours}h</td>
            <td><span class="badge">$${amount.toFixed(2)}</span></td>
            <td style="color: var(--text-muted); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${entry.description || '-'}</td>
            <td>
              <div class="actions">
                <button class="btn btn-icon" onclick="editTimeEntry('${entry._id}')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                </button>
                <button class="btn btn-danger" onclick="deleteTimeEntry('${entry._id}')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Date Filter Functions
    function setDatePreset(preset) {
      reportFilters.preset = preset;
      const today = new Date();

      // Update active button
      document.querySelectorAll('.filter-btn[data-preset]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.preset === preset);
      });

      if (preset === 'all') {
        reportFilters.startDate = null;
        reportFilters.endDate = null;
        document.getElementById('filter-start').value = '';
        document.getElementById('filter-end').value = '';
      } else if (preset === 'week') {
        // This week (Monday to Sunday)
        const dayOfWeek = today.getDay();
        const monday = new Date(today);
        monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);

        reportFilters.startDate = formatDateForInput(monday);
        reportFilters.endDate = formatDateForInput(sunday);
      } else if (preset === 'month') {
        // This month
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

        reportFilters.startDate = formatDateForInput(firstDay);
        reportFilters.endDate = formatDateForInput(lastDay);
      } else if (preset === 'lastMonth') {
        // Last month
        const firstDay = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth(), 0);

        reportFilters.startDate = formatDateForInput(firstDay);
        reportFilters.endDate = formatDateForInput(lastDay);
      }

      // Update date inputs
      document.getElementById('filter-start').value = reportFilters.startDate || '';
      document.getElementById('filter-end').value = reportFilters.endDate || '';

      // Fetch updated stats
      fetchStats();
    }

    function applyCustomDateFilter() {
      const startDate = document.getElementById('filter-start').value;
      const endDate = document.getElementById('filter-end').value;

      // Clear preset buttons
      reportFilters.preset = 'custom';
      document.querySelectorAll('.filter-btn[data-preset]').forEach(btn => {
        btn.classList.remove('active');
      });

      reportFilters.startDate = startDate || null;
      reportFilters.endDate = endDate || null;

      fetchStats();
    }

    function formatDateForInput(date) {
      return date.toISOString().split('T')[0];
    }

    async function fetchStats() {
      try {
        let statsUrl = `${API}/api/stats`;
        const params = new URLSearchParams();
        if (reportFilters.startDate) params.append('startDate', reportFilters.startDate);
        if (reportFilters.endDate) params.append('endDate', reportFilters.endDate);
        if (params.toString()) statsUrl += `?${params.toString()}`;

        const statsRes = await fetch(statsUrl);
        stats = await statsRes.json();

        renderStats();
        if (reportView === 'hierarchical') {
          renderClientBreakdown();
        } else {
          renderFlatBreakdown();
        }
      } catch (error) {
        console.error('Error fetching stats:', error);
      }
    }

    // View Toggle
    function setReportView(view) {
      reportView = view;

      // Update toggle buttons
      document.querySelectorAll('.view-toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.viewMode === view);
      });

      // Show/hide appropriate containers
      const hierarchicalContainer = document.getElementById('client-breakdown');
      const flatContainer = document.getElementById('flat-breakdown');

      if (view === 'hierarchical') {
        hierarchicalContainer.style.display = 'flex';
        flatContainer.style.display = 'none';
        renderClientBreakdown();
      } else {
        hierarchicalContainer.style.display = 'none';
        flatContainer.style.display = 'block';
        renderFlatBreakdown();
      }
    }

    // Modal Functions
    function showModal(type) {
      document.getElementById(`${type}-modal`).classList.add('active');

      if (type === 'job' || type === 'time') {
        populateClientSelect(type);
      }

      if (type === 'time') {
        document.getElementById('time-date').value = new Date().toISOString().split('T')[0];
      }

      if (type === 'invoice') {
        populateClientSelect('invoice');
        // Default to first day of current month to today
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('invoice-start').value = firstDay.toISOString().split('T')[0];
        document.getElementById('invoice-end').value = today.toISOString().split('T')[0];
      }
    }

    function closeModal(type) {
      document.getElementById(`${type}-modal`).classList.remove('active');
      document.getElementById(`${type}-form`).reset();
      if (document.getElementById(`${type}-id`)) {
        document.getElementById(`${type}-id`).value = '';
      }
      const titleMap = {
        'time': 'Log Time',
        'client': 'Add Client',
        'job': 'Add Job',
        'invoice': 'Create Invoice'
      };
      document.getElementById(`${type}-modal-title`).textContent = titleMap[type] || `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
    }

    function populateClientSelect(type) {
      const select = document.getElementById(`${type}-client`);
      select.innerHTML = `<option value="">Select a client...</option>` +
        clients.map(c => `<option value="${c._id}">${c.name}</option>`).join('');

      // Clear dependent job select if it exists
      const jobSelect = document.getElementById(`${type}-job`);
      if (jobSelect) {
        jobSelect.innerHTML = `<option value="">Select a job...</option>`;
      }
    }

    function loadJobsForClient() {
      const clientId = document.getElementById('time-client').value;
      const jobSelect = document.getElementById('time-job');
      
      const clientJobs = jobs.filter(j => j.clientId === clientId);
      jobSelect.innerHTML = `<option value="">Select a job...</option>` + 
        clientJobs.map(j => `<option value="${j._id}">${j.name}</option>`).join('');
    }

    // Client CRUD
    async function saveClient(e) {
      e.preventDefault();
      const id = document.getElementById('client-id').value;
      const data = {
        name: document.getElementById('client-name').value,
        rate: parseFloat(document.getElementById('client-rate').value),
        street: document.getElementById('client-street').value,
        city: document.getElementById('client-city').value,
        state: document.getElementById('client-state').value.toUpperCase(),
        zip: document.getElementById('client-zip').value
      };

      const url = id ? `${API}/api/clients/${id}` : `${API}/api/clients`;
      const method = id ? 'PUT' : 'POST';

      await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      closeModal('client');
      fetchData();
    }

    function editClient(id) {
      const client = clients.find(c => c._id === id);
      if (!client) return;

      document.getElementById('client-id').value = client._id;
      document.getElementById('client-name').value = client.name;
      document.getElementById('client-rate').value = client.rate;
      document.getElementById('client-street').value = client.street || '';
      document.getElementById('client-city').value = client.city || '';
      document.getElementById('client-state').value = client.state || '';
      document.getElementById('client-zip').value = client.zip || '';
      document.getElementById('client-modal-title').textContent = 'Edit Client';
      showModal('client');
    }

    async function deleteClient(id) {
      if (!confirm('Delete this client and all associated jobs and time entries?')) return;
      await fetch(`${API}/api/clients/${id}`, { method: 'DELETE' });
      fetchData();
    }

    // Job CRUD
    async function saveJob(e) {
      e.preventDefault();
      const id = document.getElementById('job-id').value;
      const data = {
        name: document.getElementById('job-name').value,
        clientId: document.getElementById('job-client').value,
        jobNumber: document.getElementById('job-number').value,
        contactName: document.getElementById('job-contact-name').value,
        contactEmail: document.getElementById('job-contact-email').value
      };

      const url = id ? `${API}/api/jobs/${id}` : `${API}/api/jobs`;
      const method = id ? 'PUT' : 'POST';

      await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      closeModal('job');
      fetchData();
    }

    function editJob(id) {
      const job = jobs.find(j => j._id === id);
      if (!job) return;

      populateClientSelect('job');
      document.getElementById('job-id').value = job._id;
      document.getElementById('job-name').value = job.name;
      document.getElementById('job-number').value = job.jobNumber || '';
      document.getElementById('job-contact-name').value = job.contactName || '';
      document.getElementById('job-contact-email').value = job.contactEmail || '';
      document.getElementById('job-client').value = job.clientId;
      document.getElementById('job-modal-title').textContent = 'Edit Job';
      showModal('job');
    }

    async function deleteJob(id) {
      if (!confirm('Delete this job and all associated time entries?')) return;
      await fetch(`${API}/api/jobs/${id}`, { method: 'DELETE' });
      fetchData();
    }

    // Time Entry CRUD
    async function saveTimeEntry(e) {
      e.preventDefault();
      const id = document.getElementById('time-id').value;
      const data = {
        clientId: document.getElementById('time-client').value,
        jobId: document.getElementById('time-job').value,
        date: document.getElementById('time-date').value,
        hours: parseFloat(document.getElementById('time-hours').value),
        description: document.getElementById('time-description').value
      };
      
      const url = id ? `${API}/api/time-entries/${id}` : `${API}/api/time-entries`;
      const method = id ? 'PUT' : 'POST';
      
      await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      closeModal('time');
      fetchData();
    }

    function editTimeEntry(id) {
      const entry = timeEntries.find(e => e._id === id);
      if (!entry) return;
      
      populateClientSelect('time');
      document.getElementById('time-id').value = entry._id;
      document.getElementById('time-client').value = entry.clientId;
      loadJobsForClient();
      
      setTimeout(() => {
        document.getElementById('time-job').value = entry.jobId;
      }, 0);
      
      document.getElementById('time-date').value = new Date(entry.date).toISOString().split('T')[0];
      document.getElementById('time-hours').value = entry.hours;
      document.getElementById('time-description').value = entry.description || '';
      document.getElementById('time-modal-title').textContent = 'Edit Time Entry';
      showModal('time');
    }

    async function deleteTimeEntry(id) {
      if (!confirm('Delete this time entry?')) return;
      await fetch(`${API}/api/time-entries/${id}`, { method: 'DELETE' });
      fetchData();
    }

    // Invoice Functions
    function renderInvoices() {
      const tbody = document.getElementById('invoices-table');

      // Filter invoices by status
      let filteredInvoices = invoices;
      if (invoiceStatusFilter !== 'all') {
        filteredInvoices = invoices.filter(inv => inv.status === invoiceStatusFilter);
      }

      if (filteredInvoices.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <p>${invoiceStatusFilter === 'all' ? 'No invoices yet. Create your first invoice!' : `No ${invoiceStatusFilter} invoices.`}</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filteredInvoices.map(invoice => {
        const startDate = new Date(invoice.startDate).toLocaleDateString('en-US', {
          month: 'short', day: 'numeric',
          timeZone: 'UTC'
        });
        const endDate = new Date(invoice.endDate).toLocaleDateString('en-US', {
          month: 'short', day: 'numeric', year: 'numeric',
          timeZone: 'UTC'
        });
        const statusClass = invoice.status === 'paid' ? 'style="background: rgba(34, 197, 94, 0.1); color: var(--success);"' : '';

        return `
          <tr>
            <td><strong>${invoice.invoiceNumber}</strong></td>
            <td>${invoice.clientName}</td>
            <td>${invoice.jobName}</td>
            <td>${startDate} - ${endDate}</td>
            <td><span class="badge">$${invoice.totalAmount.toLocaleString()}</span></td>
            <td><span class="badge" ${statusClass}>${invoice.status}</span></td>
            <td>
              <div class="actions">
                <button class="btn btn-icon" onclick="viewInvoice('${invoice._id}')" title="View Invoice">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
                <button class="btn btn-icon" onclick="toggleInvoiceStatus('${invoice._id}', '${invoice.status}')" title="${invoice.status === 'paid' ? 'Mark Unpaid' : 'Mark Paid'}">
                  <svg viewBox="0 0 24 24" fill="none" stroke="${invoice.status === 'paid' ? 'var(--success)' : 'currentColor'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                  </svg>
                </button>
                <button class="btn btn-danger" onclick="deleteInvoice('${invoice._id}')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function filterInvoices(status) {
      invoiceStatusFilter = status;

      // Update active button
      document.querySelectorAll('.filter-btn[data-invoice-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.invoiceStatus === status);
      });

      renderInvoices();
    }

    function loadJobsForInvoice() {
      const clientId = document.getElementById('invoice-client').value;
      const jobSelect = document.getElementById('invoice-job');

      const clientJobs = jobs.filter(j => j.clientId === clientId);
      jobSelect.innerHTML = `<option value="">Select a job...</option>` +
        clientJobs.map(j => `<option value="${j._id}">${j.name}</option>`).join('');
    }

    async function createInvoice(e) {
      e.preventDefault();
      const data = {
        clientId: document.getElementById('invoice-client').value,
        jobId: document.getElementById('invoice-job').value,
        startDate: document.getElementById('invoice-start').value,
        endDate: document.getElementById('invoice-end').value
      };

      try {
        const response = await fetch(`${API}/api/invoices`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const error = await response.json();
          alert(error.error || 'Failed to create invoice');
          return;
        }

        closeModal('invoice');
        fetchData();
      } catch (error) {
        console.error('Error creating invoice:', error);
        alert('Failed to create invoice');
      }
    }

    function viewInvoice(id) {
      window.open(`${API}/api/invoices/${id}/html`, '_blank');
    }

    async function toggleInvoiceStatus(id, currentStatus) {
      const newStatus = currentStatus === 'paid' ? 'unpaid' : 'paid';

      await fetch(`${API}/api/invoices/${id}/status`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      });

      fetchData();
    }

    async function deleteInvoice(id) {
      if (!confirm('Delete this invoice?')) return;
      await fetch(`${API}/api/invoices/${id}`, { method: 'DELETE' });
      fetchData();
    }

    // Quick Invoice Modal (from Job row)
    function showQuickInvoiceModal(jobId) {
      const job = jobs.find(j => j._id === jobId);
      if (!job) return;

      document.getElementById('quick-invoice-job-id').value = jobId;
      document.getElementById('quick-invoice-client-id').value = job.clientId;
      document.getElementById('quick-invoice-job-name').textContent = job.name + (job.jobNumber ? ` (${job.jobNumber})` : '');

      // Default to first day of current month to today
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      document.getElementById('quick-invoice-start').value = firstDay.toISOString().split('T')[0];
      document.getElementById('quick-invoice-end').value = today.toISOString().split('T')[0];

      document.getElementById('quick-invoice-modal').classList.add('active');
    }

    function closeQuickInvoiceModal() {
      document.getElementById('quick-invoice-modal').classList.remove('active');
      document.getElementById('quick-invoice-form').reset();
    }

    async function submitQuickInvoice(e) {
      e.preventDefault();
      const data = {
        clientId: document.getElementById('quick-invoice-client-id').value,
        jobId: document.getElementById('quick-invoice-job-id').value,
        startDate: document.getElementById('quick-invoice-start').value,
        endDate: document.getElementById('quick-invoice-end').value
      };

      try {
        const response = await fetch(`${API}/api/invoices`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const error = await response.json();
          alert(error.error || 'Failed to create invoice');
          return;
        }

        const invoice = await response.json();
        closeQuickInvoiceModal();
        fetchData();

        // Offer to view the invoice
        if (confirm(`Invoice ${invoice.invoiceNumber} created for $${invoice.totalAmount.toLocaleString()}. View it now?`)) {
          viewInvoice(invoice._id);
        }
      } catch (error) {
        console.error('Error creating invoice:', error);
        alert('Failed to create invoice');
      }
    }

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });

    // Initialize
    fetchData();
  </script>
</body>
</html>
